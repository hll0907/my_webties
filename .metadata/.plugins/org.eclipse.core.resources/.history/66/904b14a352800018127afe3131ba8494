package com.hll.web.controller;

import java.io.File;
import java.io.IOException;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;

import com.hll.web.pojo.User;
import com.hll.web.result.ResultMsg;
import com.hll.web.service.UserService;
import com.hll.web.util.PwdUtil;

import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;

@Controller
@RequestMapping("/user")
public class UserController {

	@Autowired
	UserService userService;

	@RequestMapping(value = "/selectUserdata", method = RequestMethod.GET, produces = {
			"application/json;charset=UTF-8" })
	@ApiOperation(value = "查询所有的人员信息", notes = "查询所有的人员信息")
	@ResponseBody
	public ResultMsg selectUserdata() {
		List<User> users = null;
		users = userService.selectUserAll();
		if (users == null) {
			return ResultMsg.failure("暂无用户", null, 0);
		}
		return ResultMsg.success(users);
	}

	@RequestMapping(value = "/selectUserdata", method = RequestMethod.POST, produces = {
			"application/json;charset=UTF-8" })
	@ApiOperation(value = "根据用户Id查询用户信息", notes = "根据用户Id查询用户信息")
	@ResponseBody
	@ApiImplicitParams({ @ApiImplicitParam(name = "userId", value = "用户Id", required = true, paramType = "query") })
	public ResultMsg selectUserdata(Integer userId) {
		List<User> users = null;
		users = userService.selectUserById(userId);
		if (users == null) {
			return ResultMsg.failure("暂无用户信息", null, 0);
		}
		return ResultMsg.success(users);
	}

	@RequestMapping(value = "/insterUser", method = RequestMethod.POST, produces = { "application/json;charset=UTF-8" })
	@ApiOperation(value = "新添加一个用户", notes = "新添加一个用户")
	@ResponseBody
	@ApiImplicitParams({ @ApiImplicitParam(name = "phone", value = "用户手机号", required = true, paramType = "query"),
			@ApiImplicitParam(name = "nickname", value = "用户昵称", required = true, paramType = "query"),
			@ApiImplicitParam(name = "password", value = "用户密码", required = true, paramType = "query"),
			@ApiImplicitParam(name = "head_pic", value = "用户头像", paramType = "form"), })
	public ResultMsg insterUser(String phone, String nickname, String password, String head_pic) {
		User user = new User();
		user.setPhone(phone);
		user.setNickname(nickname);
		user.setHashPassword(password);
		user.setHeadPic(head_pic);
		int insertSelective = userService.insertSelective(user);
		if (insertSelective > 0) {
			return ResultMsg.success(user);
		}
		return ResultMsg.failure("该手机号已注册,请直接登录,或联系客服", null, 0);
	}

	@RequestMapping(value = "/userLogin", method = RequestMethod.POST, produces = { "application/json;charset=UTF-8" })
	@ApiOperation(value = "用户登录", notes = "用户登录")
	@ResponseBody
	@ApiImplicitParams({ @ApiImplicitParam(name = "phone", value = "用户手机号", required = true, paramType = "query"),
			@ApiImplicitParam(name = "password", value = "用户密码", required = true, paramType = "query"), })
	public ResultMsg userLogin(String phone, String password) {
		if (phone.isEmpty() || phone.length() < 11) {
			return ResultMsg.failure("手机号格式错误", null, 0);
		}
		User user = userService.selectByPhone(phone);
		if (user == null) {
			return ResultMsg.failure("您还未注册哦", null, -1);
		}
		User userLogin = userService.userLogin(user, password);
		if (userLogin != null) {
			return ResultMsg.success("登录成功");
		}
		return ResultMsg.failure();
	}

	@RequestMapping(value = "/userUpdatePassword", method = RequestMethod.PUT, produces = {
			"application/json;charset=UTF-8" })
	@ApiOperation(value = "修改密码", notes = "修改密码")
	@ResponseBody
	@ApiImplicitParams({ @ApiImplicitParam(name = "phone", value = "手机号", required = true, paramType = "query"),
			@ApiImplicitParam(name = "oldPassword", value = "旧密码", required = true, paramType = "query"),
			@ApiImplicitParam(name = "newPassword", value = "新密码", required = true, paramType = "query") })
	public ResultMsg userUpdatePassword(String phone, String oldPassword, String newPassword) {
		User user = userService.selectByPhone(phone);
		if (user == null) {
			return ResultMsg.failure("用户不存在", null, -1);
		}
		String tempoldpassword = PwdUtil.getHashPassword(user.getSalt(), oldPassword);
		if (!tempoldpassword.equals(user.getHashPassword())) {
			return ResultMsg.failure("原密码错误", null, -2);
		}
		if (oldPassword.equals(newPassword)) {
			return ResultMsg.failure("原密码和新密码不能一样", null, -3);
		}
		user.setHashPassword(PwdUtil.getHashPassword(user.getSalt(), newPassword));
		int i = userService.updateByPrimaryKeySelective(user);
		if (i > 0) {
			return ResultMsg.success(user);
		}
		return ResultMsg.failure();
	}

	@RequestMapping(value = "/userDeldata", method = RequestMethod.DELETE, produces = {
			"application/json;charset=UTF-8" })
	@ApiOperation(value = "根据用户Id删除用户", notes = "根据用户Id删除用户")
	@ResponseBody
	@ApiImplicitParams({ @ApiImplicitParam(name = "userId", value = "用户Id", required = true, paramType = "query") })
	public ResultMsg userDeldata(Integer userId) {
		List<User> userById = userService.selectUserById(userId);
		if (userById == null) {
			return ResultMsg.failure("暂无此用户", null, 0);
		}
		int i = userService.deleteByPrimaryKey(userId);
		if (i > 0) {
			System.out.println(i);
			return ResultMsg.success(null);
		}
		return ResultMsg.failure();
	}

	@RequestMapping(value = "/upLoadHeadPic", method = RequestMethod.POST)
	@ApiOperation(value = "上传用户头像", notes = "上传用户头像")
	@ResponseBody
	public ResultMsg upLoadHeadPic(
			@ApiParam(required = true, value = "用户Id") @RequestParam(required = true) Integer userId,
			@ApiParam(required = true, value = "用户头像") @RequestParam(required = true) MultipartFile headPic,
			HttpServletRequest request, HttpServletResponse response, HttpSession session)
			throws IllegalStateException, IOException {
		List<User> userById = userService.selectUserById(userId);
		System.out.println(userId);
		System.out.println(userById);
		if (userById == null) {
			return ResultMsg.failure("暂无此用户", null, 0);
		}
		// 文件路径
		String path = null;
		// 判断上传的文件是否为空
		if (headPic != null) {
			// 文件类型
			String type = null;
			// 文件原名称
			String fileName = headPic.getOriginalFilename();
			// 判断文件类型
			type = fileName.indexOf(".") != -1 ? fileName.substring(fileName.lastIndexOf(".") + 1, fileName.length())
					: null;
			if (type != null) {
				// 判断文件类型是否为空
				if ("GIF".equals(type.toUpperCase()) || "PNG".equals(type.toUpperCase())
						|| "JPG".equals(type.toUpperCase())) {
					// 项目在容器中实际发布运行的根路径
					String realPath = request.getSession().getServletContext().getRealPath("/");
					// 自定义的文件名称
					String trueFileName = String.valueOf(System.currentTimeMillis()) + fileName;
					// 设置存放图片文件的路径
					path = realPath + trueFileName;
					// System.out.println("存放图片文件的路径:" + path);
					// 转存文件到指定的路径
					headPic.transferTo(new File(path));
				} else {
					// 不是我们想要的文件类型,请按要求重新上传
					return ResultMsg.failure();
				}
			} else {
				// 文件类型为空
				return ResultMsg.failure();
			}
		} else {
			// 没有找到相对应的文件;
			return ResultMsg.failure();
		}
		User user = new User();
		user.setId(userId);
		user.setHeadPic(path);
		int i = userService.updateByPrimaryKeySelective(user);
		if (i > 0) {
			return ResultMsg.success(userService.selectUserById(userId));
		}
		return ResultMsg.failure();
	}
}
